"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _regenerator=require("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator");var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);exports.default=versioned;exports.prefixify=prefixify;exports.multiPrefixify=multiPrefixify;var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);var _path=require("path");var _path2=_interopRequireDefault(_path);var _glob=require("glob");var _glob2=_interopRequireDefault(_glob);var _semver=require("semver");var _semver2=_interopRequireDefault(_semver);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function versioned(router){var _this=this;var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};console.log("versioned \tInitializing...");var current_version=options.hasOwnProperty("current_version")?options.current_version:require(process.cwd()+"/package.json").version;var supported_versions=options.hasOwnProperty("supported_versions")?options.supported_versions:false;var globPath=void 0;if(options.hasOwnProperty("glob")){globPath=options.glob}else{var basePath=options.hasOwnProperty("base_path")?options.base_path:process.cwd()+"/endpoints";globPath=basePath+"/v*"}console.log("versioned \tSeeking endpoints matching "+globPath);var versioned_directories=_glob2.default.sync(globPath,options.hasOwnProperty("glob_options")?options.glob_options:{});versioned_directories.forEach(function(dirname){if(_fs2.default.lstatSync(dirname).isDirectory()){console.log("versioned \tScanning directory: "+dirname);var endpoints=_glob2.default.sync(dirname+"/**/*.js");var v=dirname.split("/").pop();endpoints.forEach(function(file){if(!/.test.js/.test(file)){console.log("versioned \tRegistering endpoint: "+file);var routes=require(file).default;var route_prefix=options.hasOwnProperty("route_prefix")?options.route_prefix:"";if(current_version.substr(0,1)=="0"&&v=="v1"||_semver2.default.satisfies(current_version,v)){routes(router,multiPrefixify([""+route_prefix,route_prefix+"/"+v]))}else{routes(router,prefixify(route_prefix+"/"+v))}}})}});return function(){var _ref=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(ctx,next){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return router.routes()(ctx,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(){return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return router.allowedMethods()(ctx,next);case 2:case"end":return _context.stop();}}},_callee,_this)})));case 2:case"end":return _context2.stop();}}},_callee2,_this)}));return function(_x2,_x3){return _ref.apply(this,arguments)}}()}function prefixify(prefix){return function(path){return""+prefix+path}}function multiPrefixify(prefixes){return function(path){var result=[];prefixes.forEach(function(prefix){result.push(""+prefix+path)});return result}}
